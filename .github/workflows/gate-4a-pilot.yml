name: Gate 4A - Lab Execution Pilot (Manual Only)

# SCOPE: Single deterministic workflow for Gate 4A pilot
# - Manual trigger ONLY (workflow_dispatch)
# - NO schedule, NO push trigger
# - Fetches PINNED snapshot from Layer-1 repo at FIXED commit
# - Produces DERIVED package (structural validation only, non-interpretive)
# - Commits results back to this repo under data/derived/

on:
  workflow_dispatch:  # Manual trigger only

env:
  SOURCE_REPO: abdelkader-omran/AUTO-DZ-ACT-3I-ATLAS-DAILY
  SOURCE_COMMIT: cc4d8f9020e2a7e084ab643645bc75c18d642188
  SOURCE_PATH: data/snapshots/official_snapshot_3I_ATLAS_20251219_123807.json

jobs:
  gate-4a-pilot:
    name: Execute Gate 4A Pilot (Deterministic)
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Need write to commit DERIVED package back to repo

    steps:
      # Step 1: Checkout THIS repo (AUTO-DZ-ACT-ANALYSIS-3I-ATLAS)
      - name: Checkout Analysis Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for proper git operations
      
      # Step 2: Checkout SOURCE repo at PINNED commit into _input/ subdirectory
      - name: Checkout Source Repo (Layer-1) at Pinned Commit
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: ${{ env.SOURCE_COMMIT }}  # PINNED COMMIT (immutable)
          path: _input
          fetch-depth: 1  # Shallow clone is fine for pinned commit
      
      # Step 3: Verify pinned file exists (FAIL HARD if missing)
      - name: Verify Pinned Snapshot File
        run: |
          PINNED_FILE="_input/${{ env.SOURCE_PATH }}"
          if [ ! -f "$PINNED_FILE" ]; then
            echo "ERROR: Pinned snapshot file not found: $PINNED_FILE"
            exit 1
          fi
          echo "SUCCESS: Pinned file exists: $PINNED_FILE"
          ls -lh "$PINNED_FILE"
      
      # Step 4: Set up Python 3
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      # Step 5: Run deterministic validation + packaging script
      - name: Run Gate 4A Pilot Packaging Script
        run: |
          # Generate output directory with UTC timestamp
          TIMESTAMP_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          OUTPUT_DIR="data/derived/3i-atlas/pilot/as_of_utc=${TIMESTAMP_UTC}"

          # Input file (pinned)
          INPUT_FILE="_input/${{ env.SOURCE_PATH }}"

          # Run the packaging script
          python3 tools/gate4a_pilot_pack.py \
            --input "$INPUT_FILE" \
            --output-dir "$OUTPUT_DIR" \
            --source-repo "${{ env.SOURCE_REPO }}" \
            --source-commit "${{ env.SOURCE_COMMIT }}" \
            --source-path "${{ env.SOURCE_PATH }}"

          # Verify script succeeded
          if [ $? -ne 0 ]; then
            echo "ERROR: Packaging script failed"
            exit 1
          fi

          # Store output dir for later steps
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
      
      # Step 6: Verify all required output files exist (FAIL HARD if missing)
      - name: Verify Required Output Files
        run: |
          echo "Verifying output files in: $OUTPUT_DIR"
          
          REQUIRED_FILES=(
            "derived-status.json"
            "derived-manifest.json"
            "validation-trace.txt"
            "ro-crate-metadata.json"
            "input-snapshot.json"
          )
          
          for FILE in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$OUTPUT_DIR/$FILE" ]; then
              echo "ERROR: Required file missing: $FILE"
              exit 1
            fi
            echo "PASS: $FILE exists"
          done
          
          echo "SUCCESS: All required files exist"
      
      # Step 7: Validate RO-Crate metadata is valid JSON-LD
      - name: Validate RO-Crate Metadata
        run: |
          python3 -c "
          import json
          import sys
          
          try:
              with open('$OUTPUT_DIR/ro-crate-metadata.json', 'r') as f:
                  data = json.load(f)
              
              # Check required RO-Crate fields
              if '@context' not in data:
                  print('ERROR: Missing @context in ro-crate-metadata.json')
                  sys.exit(1)
              if '@graph' not in data:
                  print('ERROR: Missing @graph in ro-crate-metadata.json')
                  sys.exit(1)
              
              print('SUCCESS: ro-crate-metadata.json is valid JSON-LD')
              sys.exit(0)
          except Exception as e:
              print(f'ERROR: RO-Crate validation failed: {e}')
              sys.exit(1)
          "
      
      # Step 8: Validate derived-manifest.json checksums match actual files
      - name: Validate Manifest Checksums
        run: |
          python3 -c "
          import json
          import hashlib
          import sys
          from pathlib import Path
          
          def sha256_file(filepath):
              sha256_hash = hashlib.sha256()
              with open(filepath, 'rb') as f:
                  for byte_block in iter(lambda: f.read(4096), b''):
                      sha256_hash.update(byte_block)
              return sha256_hash.hexdigest()
          
          output_dir = Path('$OUTPUT_DIR')
          manifest_path = output_dir / 'derived-manifest.json'
          
          with open(manifest_path, 'r') as f:
              manifest = json.load(f)
          
          print(f'Validating {len(manifest)} files in manifest...')
          
          for filename, expected_sha256 in manifest.items():
              filepath = output_dir / filename
              if not filepath.exists():
                  print(f'ERROR: File in manifest does not exist: {filename}')
                  sys.exit(1)
              
              actual_sha256 = sha256_file(filepath)
              if actual_sha256 != expected_sha256:
                  print(f'ERROR: Checksum mismatch for {filename}')
                  print(f'  Expected: {expected_sha256}')
                  print(f'  Actual:   {actual_sha256}')
                  sys.exit(1)
              
              print(f'PASS: {filename}')
          
          print('SUCCESS: All checksums match')
          sys.exit(0)
          "
      
      # Step 9: Display derived-status.json snippet (for PR verification)
      - name: Display derived-status.json Snippet
        run: |
          echo "=== derived-status.json (first 15 lines) ==="
          head -n 15 "$OUTPUT_DIR/derived-status.json"
          echo "==="
      
      # Step 10: Upload DERIVED package as workflow artifact
      - name: Upload DERIVED Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gate-4a-derived-package
          path: ${{ env.OUTPUT_DIR }}
          retention-days: 90
      
      # Step 11: Configure Git
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # Step 12: Commit and push DERIVED package back to repo
      - name: Commit DERIVED Package
        run: |
          git add data/derived/

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit (package may already exist)"
          else
            COMMIT_MSG="chore(gate-4a): add DERIVED package from pilot run

          Gate: 4A
          Proof Type: lab-exec-pilot
          Classification: DERIVED
          Validation Scope: STRUCTURAL_ONLY

          Input Provenance:
          - Source: ${{ env.SOURCE_REPO }}
          - Commit: ${{ env.SOURCE_COMMIT }}
          - Path: ${{ env.SOURCE_PATH }}

          Output: $OUTPUT_DIR"

            git commit -m "$COMMIT_MSG"
            git push
            echo "SUCCESS: DERIVED package committed and pushed"
          fi
      
      # Step 13: Summary
      - name: Workflow Summary
        run: |
          echo "=== Gate 4A Pilot Workflow Complete ==="
          echo ""
          echo "Output Directory: $OUTPUT_DIR"
          echo ""
          echo "Files Created:"
          ls -lh "$OUTPUT_DIR"
          echo ""
          echo "SUCCESS: Deterministic lab execution pilot completed"
